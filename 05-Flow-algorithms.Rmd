# Eskdale III - Flow routing {#Eskdale_flow_algorithms}

Overland and near-surface water flow can be modelled using DEMs if we assume that surface topography is the sole factor which influences the distribution of water. One very simple model routes all water from a particular grid cell in a DEM to a single neighbouring cell (i.e. water is not partitioned between multiple neighbours). This ‘D8’ (8 direction) method sets the flow direction toward the lowest of the eight neighbouring cells, in relation to the centre cell. 


<p align="center">
<a name="Figure_1"></a>![](figures/Practical-1/D8_Principle.png){width=50%}
</p>

**Figure 1: Schematic of the D8 method**. The elevation value of the centre cell is 8 m (dark blue). Under atmospheric pressure, water flows to areas of lower elevation (< 8 m; light blue) and does not flow to areas of higher elevation (>8 m; grey). In this case, the D8 method would route all the water from the centre cell into the bottom left cell, as it has the lowest value (4 m).

Using this method, water flow is allowed in one of eight possible directions (↑ ↗ → ↘ ↓ ↙ ← ↖), assuming that water will travel along the steepest downslope path. In turn, the method is sometimes referred to as the steepest descent method. Based on the $3 * 3$ cell neighbourhood shown in [Figure 1](#Figure_1), flow would be directed from the centre cell (8 m elevation) to the southwest cell (4 m elevation).

## DEM pre-processing: flow enforcement

One common issue encountered when performing hydrological analyses is the presence of sinks, which interrupt the drainage network. When sinks are encountered, flow direction is undefined when a grid cell, or group of grid cells, is lower than all neighbouring cells (see [Figure 2](Figure_2)) When sinks are encountered, and when there are no downslope neighbours, all water that enters a cell is unable to escape. These features are referred to as pits if they are a single cell in size, and depressions if they consist of groups of cells.

<p align="center">
<a name="Figure_2"></a>![](figures/Practical-1/DEM_Sinks.png){width=50%}
</p>

**Figure 2: Schematic of a sink in a DEM**. In this $5 * 5$ matrix, water is routed into the top right cell (9 m) and then is routed to the lowest elevation cell at each step (9 m → 8 m → 7 m → 6 m → 2 m) using the D8 method (blue cells). However, the drainage network is interrupted by a sink at the 2 m cell (orange), as all neighbouring cells are of higher elevation.

Sinks can often be artefacts of the data and should be removed during DEM pre-processing. Pre-processing involves altering the elevations of the DEM in a way that enforces continuous flow-paths. However, it is important to realise that sometimes these ‘digital depressions’ reflect actual features in the landscape, and should be preserved during flow modelling. This is a particular issue for hydrological analysis of karst environments, where water can be routed into dolines and fractures. However, for our work, we will assume that all depressions in DEMs are artefacts and are justified in being removed.

Several methods have been developed for removing depressions from DEMs. These methods vary greatly in terms of their sophistication and impact on the DEM. The two most common depression removal methods [Figure 3](Figure_3) are:

- depression **filling**, which raises cells within a depression to the elevation of the outlet cell;
- depression **breaching**, which digs a trench from a depression’s bottom to some point downslope.

<p align="center">
<a name="Figure_3"></a>![](figures/Practical-1/DEM_Sinks_Fix.png){width=100%}
</p>

**Figure 3: Schematic of depression filling and breaching in a DEM**. Using the same values from [Figure 2](Figure_2), original values are modified to allow water to escape the sink (orange). Depression filling has raised the value of the sink (2 m → 4 m), while depression breaching has lowered the value of a neighbouring cell (3 m → 1 m). In this simplified example, the outputs of these two distinct approaches are identical but care should be taken when working with real world data as they will often produce different results. 

Not all interruptions to flow routing are caused by depression cells. Often, DEMs contain extensive flat regions (areas of equal elevation). Flat areas interrupt flow routing in the same way as depressions. Cells within a flat region do not have downslope neighbours, and therefore, flow routing is impossible on flat sites without pre-processing. Correction of flow direction on flat sites typically involves finding an outlet cell, forcing flow from cells adjacent to the outlet to the outlet, and continuing backwards in an iterative manner (e.g., @jenson_extracting_1988).

### Application

The DEM we are working with is centred on the Upper Eskdale catchment; an upland valley which drains the highest mountain in England (Scafell Pike; 978 m), as shown below:

<p align="center">
<a name="Figure_4"></a>![](figures/Practical-1/Eskdale_image.png){width=100%}
</p>

**Figure 4: Upper Eskdale panorama**, viewed from Harter Fell [Location: 54.386907, -3.205004, Elevation: 649 m]. The catchment ranges in elevation from 978 m (Scafell Pike) to ~160 m at the catchment outlet (white circle), and is ringed by numerous summits with elevations in excess of 800 m (white triangles). The catchment has an area of ~15.7 km<sup>2</sup> and all water which falls with the catchment ultimately drains to the Irish Sea via the River Esk. 

The DEM we are working with was downloaded from [EDINA Digimap](https://digimap.edina.ac.uk/), has a cell size of 10 m and uses the **British National Grid** (BNG), a **projected** coordinate Reference System [[EPSG:27700](https://epsg.io/27700)]. 

Unfortunately, we don't have time in this course to delve into the exciting world of map projections, although these are covered excellently by Dr. Jonny Huck in the Semester 2 course [**Understanding GIS**](https://www.manchester.ac.uk/study/masters/courses/list/07053/msc-geographical-information-science/course-details/GEOG71552#course-unit-details). However, it is important to know that different map projections have different uses and work more/less effectively in different spatial areas. As we are working within the UK, it makes sense to use a map projection which is tailored to the UK (e.g. BNG) as this minimises different types of map distortion (length, shape, area). 

When loaded into R using the `raster` package and plotted using `ggplot2` and `ggspatial`, our DEM can be visualised as follows, where the outlet point (white circle) and summits (black triangles) match those shown in [Figure 4](Figure_4). 

```{r, echo = FALSE, warning= FALSE, message = FALSE, fig.align = 'center', results='hide'}
# Sets file path for DEM and hillshade
dem_file_path <- here("data", "practical_1", "dem_10m.tif")
hillshade_file_path <- here("data", "practical_1", "hillshade_10m.tif")
outlet_file_path <- here("data", "practical_1", "pour_point.shp")

# Loads datasets
dem <- raster(dem_file_path)
hillshade <- raster(hillshade_file_path)
outlet <- st_read(outlet_file_path)

# Create vectors for Eskdale summits
name <- c("Scafell", "Scafell Pike", "Broad Crag", "Esk Pike", "Bowfell", "Crinkle Crags", "Hard Knott")
elevation <- c(964, 978, 935, 885, 902, 859, 549)
lat <- c(54.447763, 54.454305, 54.455630, 54.457189, 54.447812, 54.433763, 54.411016)
lon <- c(-3.224725, -3.211583, -3.199687, -3.179151, -3.166392, -3.160426, -3.184869)

# Combines into a data frame
summits <- data.frame(name, elevation, lat, lon)

# Converts to simple features, setting the projection to WGS84
projcrs <- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0"
summits_sf <- st_as_sf(x = summits,                         
           coords = c("lon", "lat"),
           crs = projcrs)

# Plots using ggplot
g <- ggplot() +
  layer_spatial(dem, aes(fill = stat(band1))) +
  layer_spatial(hillshade, aes(fill = stat(band1)), alpha = 2/10) +
  geom_sf(data = outlet, shape = 21, size = 3, fill = "white", colour = "black") +
  geom_sf(data = summits_sf, shape = 24, size = 2, fill = "black", colour = "black") +
  theme_classic() + 
  labs(fill = "Elevation (m)") +
  scale_fill_continuous(type = "viridis",  na.value = NA)
g
```

To accentuate areas of relief, the DEM has been combined with a semi-transparent **hillshade** layer, which is shown below:

```{r, echo = FALSE, warning= FALSE, message = FALSE, fig.align = 'center', results='hide'}

# Plots using ggplot
g <- ggplot() +
  layer_spatial(hillshade, aes(fill = stat(band1))) +
  theme_classic() +
  labs(fill = "Hillshade") +
  scale_fill_gradient(low = "black", high = "white",  na.value = NA)
g
```


To evaluate the effects of depression **breaching** and **filling**, we're going to 
 
DEM of the Upper Eskdale catchment 

```{r, eval = FALSE, warning= FALSE, message = FALSE, fig.align = 'center'}
# Sets file path for DEM
dem <- here("data", "practical_1", "dem_10m.tif")

# Breach and fills depressions
wbt_fill_depressions(dem, here("output", "practical_1", "dem_10m_fill.tif"))
wbt_breach_depressions(dem, here("output", "practical_1", "dem_10m_breach.tif"))

```





## Calculating Flow Parameters: Pointers

## Comparing flow algorithms

#-------------------- Analysis ---------------------

```{r, eval = FALSE, warning= FALSE, message = FALSE, fig.align = 'center'}
# Sets file path for DEM
dem <- here("data", "practical_1", "dem_10m.tif")

# Breach and fills depressions
wbt_fill_depressions(dem, here("output", "practical_1", "dem_10m_fill.tif"))
wbt_breach_depressions(dem, here("output", "practical_1", "dem_10m_breach.tif"))

# Calculates D8 pointer
wbt_d8_pointer(here("output", "practical_1", "dem_10m_breach.tif"), 
               here("output", "practical_1", "dem_10m_D8_pointer.tif"))

# Calculates accumulation file
wbt_d8_flow_accumulation(here("output", "practical_1", "dem_10m_breach.tif"), 
                         here("output", "practical_1", "dem_10m_flow_accumulation.tif"))

# Extracts streams, accumulation threshold of 500
wbt_extract_streams(here("output", "practical_1", "dem_10m_flow_accumulation.tif"),
                    here("output", "practical_1", "dem_10m_streams_act500.tif"), 
                    500)

# Snaps pour points to stream network, snap distance in map units (50 = 50 m)
wbt_jenson_snap_pour_points(here("data", "practical_1", "pour_point.shp"),
                            here("output", "practical_1", "dem_10m_streams_act500.tif"), 
                            here("output", "practical_1", "dem_10m_pour_point_snapped.shp"),
                            snap_dist = 50)

# Watershed from pour points
wbt_watershed(here("output", "practical_1", "dem_10m_D8_pointer.tif"), 
              here("output", "practical_1", "dem_10m_pour_point_snapped.shp"), 
              here("output", "practical_1", "dem_10m_watersheds.tif"))

# Converts watershed to vector format (polygon)
wbt_raster_to_vector_polygons(here("output", "practical_1", "dem_10m_watersheds.tif"),
                              here("output", "practical_1", "dem_10m_watersheds.shp"))

# Converts streams to vector format (lines)
wbt_raster_to_vector_lines(here("output", "practical_1", "dem_10m_streams_act500.tif"), 
                           here("output", "practical_1", "dem_10m_streams_act500.shp"))
```
