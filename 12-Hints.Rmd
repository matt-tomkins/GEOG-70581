# Handy Hints {#Hints}

This chapter contains a few handy hints which may be useful if you're having any issues loading R packages or running `Whitebox` tools. We covered most of these during our session in Week 9 but these are included here for reference.

If there are any questions regarding Assessment 2 or the practical instructions, please do get in touch at my `@manchester` email. 

### The difference between Whitebox functions and the `raster` package {-}

So far, there has been some confusion regarding the role of `whitebox` functions, the `raster` package and `ggplot2`. Each of these has a unique role, as visualised below, while analysis needs to be conducted in the correct order to avoid errors. 

<p align="center">
<a name="Analysis_order"></a>![](figures/Practical-2/wbt_raster_ggplot.png){width=100%}
</p>

**Analysis structure**. [1] Create output files using `whitebox` [2] Load outputs into R using `raster` [3] Plot them using `ggplot`

</p>

To illustrate this, below we have an example of the `wbt_d8_pointer` function, which creates a D8 pointer file based on an input digital elevation model (dem):

```{r, echo = TRUE, eval = FALSE, warning= FALSE, message = FALSE, fig.align = 'center'}

# Creates a D8 pointer file (.tif) at the output location, based on the input dem
wbt_d8_pointer(dem = here("data", "practical_2", "mersey_dem_fill.tif"),
               output = here("output", "practical_2", "mersey_dem_D8_pointer.tif"))
```

This uses the `here` package for locating the input file (`mersey_dem_fill.tif`), which is stored in `data/practical_2`, and for saving the output, which is stored as `mersey_dem_D8_pointer.tif` in `output/practical_2`. 

If this runs successfully (make sure to carefully check file paths, file names, use of commas), then an output raster will be created at the specified location.

**Crucially**, this does **not** load the raster into the R environment, so any attempt to plot the raster using `ggplot2` would fail. 

To achieve this, a raster must be first loaded into the R environment as follows: 

```{r, echo = TRUE, eval = TRUE, warning= FALSE, message = FALSE, fig.align = 'center'}

# Loads D8 pointer raster using the raster and here packages
mersey_pointer <- raster(here("output", "practical_2", "mersey_dem_D8_pointer.tif"))

```

Again, we have determined the input file location using `here` package (`output/practical_2/mersey_dem_D8_pointer.tif`) and stored the raster as an object in the R environment called `mersey_pointer`. 

With this stored, it can then be plotted using `ggplot`, setting  `layer_spatial` to the `mersey_pointer` object name:

```{r, echo = TRUE, eval = TRUE, warning= FALSE, message = FALSE, fig.align = 'center'}

# Plots using ggplot
p <- ggplot() +
  layer_spatial(mersey_pointer, aes(fill = stat(band1))) +
  theme_classic() + 
  labs(fill = "Pointer value", x = "Easting", y = "Northing") +
  scale_fill_continuous(type = "viridis",  na.value = NA)
p 
```

**TLDR**: for subsequent analysis, make sure to adhere to the following structure:

1. Create output files using `whitebox` functions.

2. Load those output files into R using the `raster` package (stored as objects)

3. Plot the R objects using `ggplot2`

Any deviation from this order (e.g. plotting without loading using `raster`, loading files that have not yet been created using `whitebox`) will cause errors!



### R Projects {-}

Make sure to initialise an R project for your work ([Section 5.4](#R_Projects)) and ensure this is created for your GEOG70581 directory. This should resemble the following, with the R **project file** and a separate **R script** for the Eskdale and Mersey Basin practicals:

<p align="center">
![](figures/Using-R/R-project-visualisation.png){width=65%}
</p>

### File paths {-}

Remove spaces in directories or file paths. As a rule, avoid using spaces when naming files or folders as this can cause issues, particularly when coding: 

- "P:/Environmental Monitoring Concepts/GEOG70581/..." *Bad*
- "P:/Environmental_Monitoring_Concepts/GEOG70581/..." *Good*
  
</p>

### Error messages {-}

Make sure to read error messages (red text in the R console). If this appears, it usually means that something has gone wrong! 

### Output files {-}

Make sure to inspect output files. When you run a command (e.g. a Whitebox function), check that it produces the intended output (e.g. a raster file (.tif) in the output directory). If there is an error or the output hasn't been created, subsequent code will fail. 

### Packages {-}

If you're having difficulty loading the `raster` or `sf` packages on a University managed computer, this is due to multiple package installs. Go to the packages window, identify the **older** version of each package, and tick the check box to load it into your R library. 

### Code structure {-}

While you will **not** be assessed on the quality of your code (you do **not** have to submit your code for the assessment), remember that well-formatted code (with comments and good structure) is easier to read and understand and will be less prone to error. 

> Inspect the code below:

```{r, echo = TRUE, eval = FALSE, warning= FALSE, message = FALSE, fig.align = 'center'}

# Function to check and install packages
check.packages <- function(pkg){
  new.pkg <- pkg[!(pkg %in% installed.packages()[, "Package"])]
  if (length(new.pkg))
    install.packages(new.pkg, dependencies = TRUE)
  sapply(pkg, require, character.only = TRUE)
}

# Checks and installs packages
packages <- c("ggplot2", "sf", "here", "raster", "whitebox", "ggspatial", "patchwork")
check.packages(packages)

# Sets file path for DEM
dem <- here("data", "practical_1", "dem_10m.tif")

# Breach and fills depressions
wbt_fill_depressions(dem, here("output", "practical_1", "dem_10m_fill.tif"))
wbt_breach_depressions(dem, here("output", "practical_1", "dem_10m_breach.tif"))

# Calculates D8 pointer
wbt_d8_pointer(here("output", "practical_1", "dem_10m_fill.tif"),
               here("output", "practical_1", "dem_10m_D8_pointer.tif"))

# Calculates D8 accumulation file (SCA), with log-transformed values
wbt_d8_flow_accumulation(here("output", "practical_1", "dem_10m_fill.tif"),
                         here("output", "practical_1", "dem_10m_flow_accumulation.tif"),
                         out_type = "specific contributing area",
                         log = "TRUE")
 
```

This code includes comments for each main code block, line spaces to distinguish different parts of the code, and is written in a logical order (e.g. first loading packages, then loading/selecting data, running tools). Any non-essential code has been removed e.g. additional calls to install.packages() or library(). 

If there are any other questions, please do get in touch. 
